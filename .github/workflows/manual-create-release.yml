# ██╗ ██████╗ ████████╗ █████╗ ██████╗
# ██║██╔═══██╗╚══██╔══╝██╔══██╗╚════██╗
# ██║██║   ██║   ██║   ███████║ █████╔╝
# ██║██║   ██║   ██║   ██╔══██║██╔═══╝
# ██║╚██████╔╝   ██║   ██║  ██║███████╗
# ╚═╝ ╚═════╝    ╚═╝   ╚═╝  ╚═╝╚══════╝
# Copyright (c) 2025 iota2 (iota2 Engineering Tools)
# Licensed under the MIT License. See LICENSE file in the project root for details.

name: Create release from tag (manual)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g. v0.2.0). Leave empty to use latest tag.'
        required: false
        default: ''
      base_tag:
        description: 'Base tag to compute release notes from (e.g. v0.1.0). If empty, previous tag is auto-selected.'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history and tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0      # full history
          fetch-tags: true    # ensure tags are available

      - name: Bump MAJOR version (reset minor & patch)
        id: bump_major
        run: |
          set -e
          CURRENT=$(cat VERSION | sed 's/^v//')
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          NEW_MAJOR=$((MAJOR + 1))
          NEW_VERSION="v${NEW_MAJOR}.0.0"
          echo "$NEW_VERSION" > VERSION
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Show bumped version
        run: echo "Bumped release version to ${{ steps.bump_major.outputs.new_version }}"

      - name: Determine tag to release
        id: tagpick
        run: |
          set -euo pipefail
          INPUT_TAG="${{ github.event.inputs.tag }}"
          if [ -n "$INPUT_TAG" ]; then
            TAG="$INPUT_TAG"
          else
            TAG=$(git tag --sort=-v:refname | head -n1)
          fi
          if [ -z "$TAG" ]; then
            echo "No tags found in repository" >&2
            exit 1
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Selected tag: $TAG"

      - name: Determine base tag (previous or provided)
        id: basepick
        run: |
          set -euo pipefail
          INPUT_BASE="${{ github.event.inputs.base_tag }}"
          TAG="${{ steps.tagpick.outputs.tag }}"

          if [ -n "$INPUT_BASE" ]; then
            BASE="$INPUT_BASE"
            echo "Using provided base_tag: $BASE"
          else
            TAG_LIST=$(git tag --sort=-v:refname)
            BASE=""
            found=0
            while IFS= read -r t; do
              if [ "$found" -eq 1 ]; then
                BASE="$t"
                break
              fi
              if [ "$t" = "$TAG" ]; then
                found=1
              fi
            done <<< "$TAG_LIST"

            if [ -z "$BASE" ]; then
              echo "No previous tag found; base will be empty (release will include full history up to $TAG)"
            else
              echo "Auto-detected previous tag: $BASE"
            fi
          fi

          echo "base=${BASE:-}" >> "$GITHUB_OUTPUT"

      - name: Generate compact release notes
        id: gen_notes
        run: |
          python3 tools/generate_release_notes.py \
            --tag "${{ steps.tagpick.outputs.tag }}" \
            --base "${{ steps.basepick.outputs.base }}" \
            --repo "${{ github.repository }}"

      - name: Commit version bump
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add VERSION
          git commit -m "chore(release): bump version to ${{ steps.bump_major.outputs.new_version }}" || echo "No version change to commit"

      - name: Create and push tag
        run: |
          git tag ${{ steps.bump_major.outputs.new_version }}
          git push origin ${{ steps.bump_major.outputs.new_version }}

      - name: Create GitHub release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ steps.bump_major.outputs.new_version }}
          release_name: ${{ steps.bump_major.outputs.new_version }}
          body: ${{ steps.gen_notes.outputs.body }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}